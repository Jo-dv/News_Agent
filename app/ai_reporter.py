from langchain_ollama import ChatOllama
from langchain_core.prompts import ChatPromptTemplate

llm = ChatOllama(
    model="coolsoon/kanana-1.5-8b", 
    base_url="http://ollama:11434",
    temperature=0.1 
)

def generate_daily_report(news_list):
    print("\n[AI 분석] 카나나 모델이 인사이트 리포트를 작성합니다...")
    
    news_text_block = ""
    for i, news in enumerate(news_list, 1):
        news_text_block += f"[기사 {i}]\n제목: {news['title']}\n링크: {news['link']}\n본문: {news['content'][:400]}...\n\n"

    prompt = ChatPromptTemplate.from_messages([
        ("system", """당신은 최고 수준의 테크/비즈니스 수석 애널리스트입니다. 
주어진 최신 뉴스 기사들을 분석하여 '전문적이고 가독성 높은 이메일 브리핑 리포트'를 작성하세요.

[🚨 엄격한 절대 규칙]
1. 기사 개수 1:1 매칭: 전달받은 기사가 1개면 [기사 1]만 작성하고 다음 섹션으로 넘어가세요. 절대 [기사 2], [기사 3] 등 없는 빈 항목을 만들거나 '해당 사항 없음'이라고 적지 마세요.
2. 메타 발언 금지: 리포트의 시작이나 끝에 프롬프트 지시사항(예: "제공된 기사 개수에 따라...")이나 인사말, 부연 설명을 절대 기재하지 마세요. 양식의 내용만 출력하고 즉시 종료하세요.
3. 용어 사전 엄격 제한: '초저리 대출', '전고체 배터리' 등 진짜 난해한 금융/기술 전문 용어만 최대 3개 이내로 추출하세요. '투자', '수출', '지원', '강화' 등 일반적인 단어는 절대 포함하지 마세요. 추출할 만한 어려운 단어가 없으면 내용에 "해당 사항 없음" 딱 한 줄만 출력하세요."""),
        
        ("human", """
오늘의 리포트 주제: 매일경제 금융정책 동향

[뉴스 데이터]
{news_data}

위 데이터를 바탕으로 아래 [출력 템플릿]의 구조와 기호를 그대로 사용하여 리포트를 작성하세요. 

[출력 템플릿]
=========================================
 📈 [매일경제 금융정책] 일일 동향 브리핑
=========================================

■ 1. 오늘의 핵심 요약 (전체 관통 3줄 요약)
- 
- 
- 

-----------------------------------------
■ 2. 주요 뉴스 상세

▶ [기사 1] 기사 제목
- 핵심 요약 1
- 핵심 요약 2
🔗 원문 링크: 기사 URL

(주의: 기사가 여러 개일 경우에만 위 '▶ [기사 N]' 블록을 추가로 생성하세요.)

-----------------------------------------
■ 3. 애널리스트 인사이트 (시장/산업 트렌드 분석)
- 
- 

-----------------------------------------
■ 4. 주요 용어 사전 (최대 3개, 일반 단어 금지)
- 
""")
    ])

    chain = prompt | llm
    
    try:
        response = chain.invoke({"news_data": news_text_block})
        print("[분석 완료] 리포트 생성 완료!")
        return response.content
    except Exception as e:
        print(f"[에러] 리포트 생성 실패: {e}")
        return None