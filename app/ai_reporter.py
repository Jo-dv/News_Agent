from langchain_ollama import ChatOllama
from langchain_core.prompts import ChatPromptTemplate

llm = ChatOllama(
    model="coolsoon/kanana-1.5-8b", 
    base_url="http://ollama:11434",
    temperature=0.1 
)

def generate_daily_report(news_list):
    print("\n[AI 분석] 카나나 모델이 인사이트 리포트를 작성합니다...")
    
    news_text_block = ""
    for i, news in enumerate(news_list, 1):
        news_text_block += f"[기사 {i}]\n제목: {news['title']}\n링크: {news['link']}\n본문: {news['content'][:400]}...\n\n"

    # 🚨 [초강력 통제] 유동적인 기사 개수와 까다로운 용어 사전 규칙을 추가합니다.
    prompt = ChatPromptTemplate.from_messages([
        ("system", """당신은 최고 수준의 테크/비즈니스 수석 애널리스트입니다. 
주어진 최신 뉴스 기사들을 분석하여 '전문적이고 가독성 높은 이메일 브리핑 리포트'를 작성하세요.

[🚨 엄격한 작성 규칙 - 위반 시 시스템 오류 발생]
1. 유동적 기사 매칭: 제공된 기사의 개수를 정확히 파악하세요. 기사가 3개면 3개, 5개면 5개를 누락 없이 '입력받은 기사 수만큼' 모두 [기사 N] 항목으로 생성해야 합니다.
2. 1기사 1링크 원칙: 각 기사의 요약이 끝난 직후, '🔗 원문 링크: [URL]' 형태로 딱 한 번만 링크를 기재하세요. 중복 삽입이나 가짜 링크 생성을 금지합니다.
3. 이메일 가독성: 마크다운 기호(#, **, *) 대신 제공된 템플릿의 기호(■, ▶, -, 🔗)와 구분선(===, ---)을 그대로 사용하세요.
4. 엄격한 금융 용어 선정: 각 기사에서 핵심적인 역할을 하는 '어려운 금융/경제 전문 용어'만 최대 10개까지 추출해 설명하세요. 만약 설명할 만한 전문 용어가 없다면 억지로 만들지 말고 '해당 사항 없음'이라고 기재하세요.
5. 인사말/맺음말 절대 금지: 템플릿 양식 외의 불필요한 문장(예: '분석을 시작합니다', '감사합니다')은 절대 쓰지 마세요."""),
        
        ("human", """
오늘의 리포트 주제: 매일경제 금융정책 동향

[뉴스 데이터]
{news_data}

위 뉴스 데이터를 바탕으로, 반드시 아래의 [출력 템플릿] 형태와 기호들을 똑같이 복사해서 내용만 채워 넣어주세요.

[출력 템플릿]
=========================================
 📈 [매일경제 금융정책] 일일 동향 브리핑
=========================================

■ 1. 오늘의 핵심 요약 (전체 관통 3줄 요약)
- (요약 내용 1)
- (요약 내용 2)
- (요약 내용 3)

-----------------------------------------
■ 2. 주요 뉴스 상세

▶ [기사 1] (원문 제목을 그대로 기재하세요)
- (기사 내용의 핵심 요약 1)
- (기사 내용의 핵심 요약 2)
🔗 원문 링크: (기사 1의 원문 링크)

(🚨 제공된 기사 개수만큼 위 '▶ [기사 N]' 양식을 반복해서 모두 작성하세요. 기사를 쪼개거나 없는 기사를 지어내지 마세요.)

-----------------------------------------
■ 3. 애널리스트 인사이트 (시장/산업 트렌드 분석)
- (분석 1)
- (분석 2)

-----------------------------------------
■ 4. 주요 용어 사전 (최대 10개, 핵심 금융 용어만. 없으면 '해당 사항 없음' 기재)
- (용어 1): (설명)
- (용어 2): (설명)
""")
    ])

    chain = prompt | llm
    
    try:
        response = chain.invoke({"news_data": news_text_block})
        print("[분석 완료] 리포트 생성 완료!")
        return response.content
    except Exception as e:
        print(f"[에러] 리포트 생성 실패: {e}")
        return None